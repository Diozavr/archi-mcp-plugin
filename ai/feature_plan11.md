### План: Удаление внутреннего MCP JSON-RPC сервера (feature-plan 11)

## Цель
- Убрать встроенную поддержку MCP JSON-RPC протокола из плагина
- Оставить только вариант через универсальный npx пакет `@tyk-technologies/api-to-mcp` с OpenAPI спецификацией
- Упростить архитектуру и уменьшить поверхность кода для поддержки

## Контекст/Предпосылки
- В текущей версии плагин поддерживает два способа MCP интеграции:
  1. Встроенный JSON-RPC сервер на эндпоинте `/mcp` с собственным `ToolRegistry`
  2. Универсальный способ через npx пакет, который генерирует MCP инструменты из OpenAPI спецификации
- Универсальный способ через Tyk более гибкий, автоматически синхронизируется с REST API и не требует дублирования логики
- Встроенный MCP сервер добавляет сложность и требует ручной синхронизации описаний инструментов

## Инварианты
- Локальный сервер остается только на `127.0.0.1`
- REST API остается полностью функциональным
- OpenAPI спецификация остается актуальной и полной
- Операции с EMF/SWT — через `Display.getDefault().syncExec(...)`

## Компоненты для удаления

### 1. MCP JSON-RPC инфраструктура
**Файлы для удаления:**
- `com/archimatetool/mcp/http/handlers/JsonRpcHttpHandler.java` — основной JSON-RPC обработчик
- `com/archimatetool/mcp/server/tools/Tool.java` — описание MCP инструмента
- `com/archimatetool/mcp/server/tools/ToolRegistry.java` — реестр MCP инструментов
- `com/archimatetool/mcp/server/tools/ToolInvoker.java` — интерфейс вызова инструментов
- `com/archimatetool/mcp/server/tools/ToolParam.java` — параметры MCP инструментов

### 2. Маршрутизация
**Изменения в файлах:**
- `com/archimatetool/mcp/http/Router.java` — удалить регистрацию `/mcp` эндпоинта

### 3. Документация
**Файлы для обновления:**
- `README.md` — убрать раздел про встроенный JSON-RPC, оставить только npx способ
- `AGENTS.md` — убрать описание JSON-RPC протокола, оставить только OpenAPI инструкции
- `resources/openapi.json` — проверить актуальность (может остаться без изменений)

## Шаги реализации

### 1. Анализ зависимостей
- **Статус**: [done]
- **Сделано**: проверены импорты `server.tools`, REST API и тесты не зависят от MCP
- **Осталось**: —
- **Задача**: Проанализировать все места использования MCP-компонентов
- **Действия**:
  - Найти все импорты классов из пакета `com.archimatetool.mcp.server.tools.*`
  - Убедиться, что REST API не зависит от MCP инфраструктуры
  - Проверить тесты на использование MCP компонентов

### 2. Удаление MCP JSON-RPC обработчика
- **Статус**: [done]
- **Сделано**: удалён `JsonRpcHttpHandler` и его регистрация
- **Осталось**: —
- **Задача**: Убрать `JsonRpcHttpHandler` и его регистрацию
- **Действия**:
  - Удалить файл `JsonRpcHttpHandler.java`
  - Убрать импорт и регистрацию в `Router.java`: `server.createContext("/mcp", new JsonRpcHttpHandler());`
  - Проверить отсутствие других ссылок на класс

### 3. Удаление MCP Tools инфраструктуры
- **Статус**: [done]
- **Сделано**: удалён пакет `server.tools`
- **Осталось**: —
- **Задача**: Убрать весь пакет `com.archimatetool.mcp.server.tools.*`
- **Действия**:
  - Удалить `Tool.java`
  - Удалить `ToolRegistry.java`
  - Удалить `ToolInvoker.java`
  - Удалить `ToolParam.java`
  - Удалить всю папку `tools/`

### 4. Очистка импортов и зависимостей
- **Статус**: [done]
- **Сделано**: удалены импорты и проверена компиляция
- **Осталось**: —
- **Задача**: Убрать неиспользуемые импорты после удаления MCP компонентов
- **Действия**:
  - Пройтись по всем Java файлам и убрать импорты удаленных классов
  - Проверить компиляцию проекта
  - Убрать неиспользуемые зависимости из `MANIFEST.MF` (если есть)

### 5. Обновление документации
- **Статус**: [done]
- **Сделано**: README и AGENTS очищены от JSON-RPC
- **Осталось**: —
- **Задача**: Обновить документацию, убрав ссылки на встроенный MCP
- **Действия**:
  - В `README.md`:
    - Убрать раздел "MCP JSON-RPC" со встроенными примерами
    - Оставить только раздел "MCP Server через npx"
    - Убрать упоминания эндпоинта `/mcp`
  - В `AGENTS.md`:
    - Убрать раздел "MCP JSON-RPC" с описанием протокола
    - Оставить только раздел "MCP Server через npx"
    - Убрать примеры JSON-RPC вызовов
    - Обновить раздел "Быстрые проверки", убрав проверки MCP эндпоинта

### 6. Обновление тестов
- **Статус**: [done]
- **Сделано**: удалены JSON-RPC тесты
- **Осталось**: —
- **Задача**: Убрать или адаптировать тесты MCP функциональности
- **Действия**:
  - Найти тесты, использующие `/mcp` эндпоинт
  - Удалить тесты специфичные для JSON-RPC протокола
  - Обновить smoke-тесты, убрав проверки MCP эндпоинта
  - Убедиться, что REST API тесты остались работоспособными

### 7. Проверка OpenAPI актуальности
- **Статус**: [done]
- **Сделано**: подтверждена полнота `openapi.json`
- **Осталось**: —
- **Задача**: Убедиться, что OpenAPI спецификация полная и актуальная
- **Действия**:
  - Проверить, что все REST эндпоинты описаны в `openapi.json`
  - Убедиться, что описания параметров полные и корректные
  - Протестировать генерацию MCP инструментов через Tyk пакет

### 8. Финальное тестирование
- **Статус**: [done]
- **Сделано**: сервер протестирован, `/mcp` возвращает 404
- **Осталось**: —
- **Задача**: Протестировать работоспособность после удаления MCP компонентов
- **Действия**:
  - Запустить плагин и убедиться в работоспособности REST API
  - Проверить, что `/mcp` эндпоинт возвращает 404
  - Протестировать работу через npx пакет: `npx @tyk-technologies/api-to-mcp@latest --spec http://127.0.0.1:8765/openapi.json`
  - Запустить существующие smoke-тесты (исключая MCP-специфичные)

## Ведение прогресса по шагам
- Для каждого шага поддерживать чек-лист:
  - Статус: [done|partial|todo]
  - Сделано: краткий перечень завершённых подпунктов
  - Осталось: оставшиеся подпункты/блокеры

## DoD (Definition of Done)
- Удалены все файлы MCP JSON-RPC инфраструктуры
- Эндпоинт `/mcp` больше не существует (404)
- REST API полностью функционален
- MCP интеграция работает только через npx пакет с OpenAPI
- Документация обновлена и не содержит ссылок на встроенный MCP
- Все тесты проходят (кроме удаленных MCP-специфичных)
- Smoke-тесты адаптированы под новую архитектуру

## Тестирование
- **Регрессионные тесты**: Убедиться, что REST API работает без изменений
- **Интеграционные тесты**: Протестировать MCP через npx пакет
- **Smoke-тесты**: Адаптировать существующие smoke-тесты

## Преимущества после рефакторинга
- **Упрощение архитектуры**: Меньше кода для поддержки
- **Единый источник правды**: Только OpenAPI спецификация
- **Автоматическая синхронизация**: MCP инструменты всегда актуальны
- **Универсальность**: Любой OpenAPI сервис может стать MCP сервером
- **Меньше дублирования**: Не нужно поддерживать два способа описания API

## Риски и митигация
- **Риск**: Пользователи используют встроенный MCP эндпоинт
  - **Митигация**: Четкая коммуникация об изменениях, обновление документации
- **Риск**: Проблемы с npx пакетом
  - **Митигация**: Тестирование интеграции, fallback инструкции
- **Риск**: Потеря функциональности
  - **Митигация**: Убедиться, что OpenAPI спецификация полная

## Роллбэк план
- Восстановить удаленные файлы из git истории
- Восстановить регистрацию `/mcp` эндпоинта в Router
- Откатить изменения в документации
